<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dublin Cleaners</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --font-family:'Roboto','Helvetica Neue',Arial,sans-serif;
  --color-primary:#1B365D;
  --color-secondary:#8BC34A;
  --color-bg:#F5F7FA;
  --color-surface:#FFFFFF;
  --color-text:#000;
  --radius:8px;
  --shadow:0 2px 4px rgba(0,0,0,.08);
  --text-h1:2.25rem;
  --text-h2:1.75rem;
  --text-h3:1.375rem;
  --text-body:1rem;
  --text-small:0.875rem;
  --space-1:4px;
  --space-2:8px;
  --space-3:12px;
  --space-4:16px;
  --space-5:24px;
  --space-6:32px;
  --transition:all .25s ease;
}
@media (prefers-color-scheme: dark){
  :root{--color-bg:#121212;--color-surface:#1F1F1F;--color-text:#E0E0E0;}
}
body{font-family:var(--font-family);background:var(--color-bg);color:var(--color-text);margin:0;font-size:var(--text-body);line-height:1.6;}
h1{font-size:var(--text-h1);margin:0 0 var(--space-4);}
h2{font-size:var(--text-h2);margin:0 0 var(--space-3);}
h3{font-size:var(--text-h3);margin:0 0 var(--space-3);}
.dc-container{padding:var(--space-5);}
.dc-header{display:flex;align-items:center;justify-content:space-between;background:var(--color-primary);color:#fff;padding:var(--space-2) var(--space-4);}
.dc-logo{height:120px;}
.dc-nav button{background:none;border:none;color:#fff;margin-right:var(--space-2);cursor:pointer;font-size:var(--text-body);transition:var(--transition);}
.dc-nav button:hover{color:var(--color-secondary);}
.dc-actions{display:flex;align-items:center;gap:var(--space-2);}
.dc-lang-toggle button{background:none;border:none;color:#fff;cursor:pointer;font-size:var(--text-body);padding:0 var(--space-1);}
.dc-lang-toggle button.active{text-decoration:underline;font-weight:bold;}
.dc-btn{background:var(--color-primary);color:#fff;border:none;border-radius:var(--radius);padding:var(--space-2) var(--space-4);cursor:pointer;transition:var(--transition);}
.dc-btn:hover{background:#162c4a;}
.dc-card{background:var(--color-surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--space-4);margin-bottom:var(--space-5);}
.dc-grid{display:grid;gap:var(--space-3);grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
.dc-badge{background:var(--color-secondary);color:#fff;padding:var(--space-1) var(--space-2);border-radius:var(--radius);font-size:var(--text-small);}
.dc-text-small{font-size:var(--text-small);}
.hidden{display:none;}
.dc-footer{text-align:center;padding:var(--space-4);font-size:var(--text-small);color:#555;}
.loading-bar{height:4px;background:#eee;position:relative;overflow:hidden;}
.loading-bar span{display:block;height:100%;background:var(--color-primary);width:100%;animation:loadAnim 1.2s linear infinite;}
@keyframes loadAnim{from{transform:translateX(-100%);}to{transform:translateX(100%);}}
</style>
<script>
let user=null,config={},lang=localStorage.getItem('lang')||'en';
let loadingReviews=false;
let pendingSection=null;
let currentReviewId=null;
let selectedYear=new Date().getFullYear();

const defaultQuestions=[
  {id:'attendance',en:'Attendance & Punctuality',es:'Asistencia y Puntualidad',extras:[
    {id:'absences',label:'Absences without notice (days)',label_es:'Ausencias sin aviso (días)',type:'number'},
    {id:'late',label:'Late arrivals (days)',label_es:'Llegadas tarde (días)',type:'number'},
    {id:'comments',label:'Comments',label_es:'Comentarios',type:'textarea'}]},
  {id:'performance',en:'Performance Improvements: What did you do more, better, or more efficiently last year, up till now?',es:'Mejoras de rendimiento',extra:'textarea'},
  {id:'values',en:'Living Our Core Values: How have you embodied our core values? Provide specific examples.',es:'Vivir nuestros valores',extra:'textarea'},
  {id:'growth',en:'Personal Growth: How did you improve your knowledge or skills last year, up till now?',es:'Crecimiento personal',extra:'textarea'},
  {id:'learning',en:'Learning New Skills: Did you take or create opportunities to learn a new skill or enhance an existing one?',es:'Aprendizaje de nuevas habilidades',extra:'textarea'},
  {id:'team',en:'Team Support: How did you support your teammates in developing their skills?',es:'Apoyo al equipo',extra:'textarea'},
  {id:'flexibility',en:'Flexibility: When asked to cover for others, did you agree? Share an example.',es:'Flexibilidad',extra:'textarea'},
  {id:'initiative',en:'Initiative: Describe a time you proactively improved a process or solved a problem without being asked.',es:'Iniciativa',extra:'textarea'},
  {id:'proactive',en:'Proactive Contributions: How did you proactively use downtime to tackle additional tasks?',es:'Contribuciones proactivas',extra:'textarea'},
  {id:'innovation',en:'Innovation & Process Improvement: Have you suggested or implemented improvements to our processes, services, or workplace? Describe your idea and its impact.',es:'Innovaci\u00f3n y mejora de procesos',extra:'textarea'},
  {id:'crossshadow',en:'Cross Shadowing Program Participation',es:'Programa Cross Shadowing',rating:false,extras:[
    {id:'participation',label:'Did you participate? (Yes/No/Partial)',label_es:'¿Participaste? (Sí/No/Parcial)',type:'select',options:['Yes','No','Partial']},
    {id:'comments',label:'Comments',label_es:'Comentarios',type:'textarea'}]},
  {id:'future',en:'Future Interests: Is there another role or skill you\u2019d like to explore in the future?',es:'Intereses futuros',rating:false,extra:'textarea'}
];
const translations={
  en:{
    home:'Home',reviews:'Reviews',schedule:'Schedule',navTitle:'Employee Annual Reviews',
    welcomeTitle:'Welcome to the Employee Review Portal',
    welcomeMsg:'Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.',
    comingSoon:'Coming soon...',userId:'User ID',password:'Password',login:'Login',logout:'Logout',
    loginFail:'Login failed',invalidPwd:'Invalid password.',
    noAccount:'Account not found. Please reach out to Sea Khun to be added.',
    curWage:'Current Wage',newWage:'New Wage',pctIncrease:'% Increase:',
    finalExpTitle:'Final Performance Expectation',belowExp:'Below Expectations',meetsExp:'Meets Expectations',exceedsExp:'Exceeds Expectations',
    below:'Below',meets:'Meets',exceeds:'Exceeds',
    notesPlaceholder:'Notes',contactQuestions:'Contact Sea Khun with questions.',empSignature:'Employee Signature',mgrSignature:'Manager Signature',submitReview:'Submit Review',
    reviewSaved:'Review saved',saveFailed:'Failed to save review',saving:'Saving...',
    intro:`<section id="review-intro">
      <h1>Dublin Cleaners 2025 Employee Annual Reviews – Your Opportunity to Shine</h1>
      <div class="intro-cards">
        <div class="info-card">
          <h2>Purpose</h2>
          <p>Highlight achievements, live our core values, and explain why you deserve a pay increase while receiving growth feedback.</p>
        </div>
        <div class="info-card">
          <h2>Core Values</h2>
          <ul class="values-list">
            <li>Accountable</li>
            <li>Attention to Details</li>
            <li>Team Player</li>
            <li>Tactical Risk Taker</li>
            <li>Better than Yesterday</li>
            <li>Value Reputation</li>
          </ul>
        </div>
        <div class="info-card">
          <h2>Rating System &amp; Process</h2>
          <div class="rating-badges">
            <span class="badge badge-gray">Below Expectations</span>
            <span class="badge badge-green">Meets Expectations</span>
            <span class="badge badge-gold">Exceeds Expectations</span>
          </div>
          <p>(Attendance &amp; punctuality, Q1, is weighted higher)</p>
          <div class="process">
            <span>July reviews</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>submit form</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>Manager/Assistant adds notes</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>schedule 20-min meeting (half-hour slots) ≥ 1 week after submission</span>
          </div>
          <p>Schedule outside regular hours; compensated if on day off/outside shift.</p>
          <p>Please Message HR about how long your meeting was so they can Add your hours into UKG</p>
        </div>
      </div>
      <div class="callout">Raises take effect on the first pay period in August.</div>
    </section>`
  },
  es:{
    home:'Inicio',reviews:'Reseñas',schedule:'Agenda',navTitle:'Revisiones Anuales de Empleados',
    welcomeTitle:'Bienvenido al Portal de Evaluaciones',
    welcomeMsg:'Seleccione una opción en la barra de navegación para ver sus evaluaciones o programar una reunión. Use el botón de idioma para cambiar entre inglés y español.',
    comingSoon:'Próximamente...',userId:'ID de usuario',password:'Contraseña',login:'Iniciar sesión',logout:'Cerrar sesión',
    loginFail:'Error al iniciar sesión',invalidPwd:'Contraseña inválida.',
    noAccount:'Cuenta no encontrada. Por favor contacte a Sea Khun para ser agregado.',
    curWage:'Salario actual',newWage:'Nuevo salario',pctIncrease:'% Aumento:',
    finalExpTitle:'Expectativa de desempeño final',belowExp:'Debajo de las expectativas',meetsExp:'Cumple con las expectativas',exceedsExp:'Supera las expectativas',
    below:'Debajo',meets:'Cumple',exceeds:'Supera',
    notesPlaceholder:'Notas',contactQuestions:'Contacte a Sea Khun con preguntas.',empSignature:'Firma del empleado',mgrSignature:'Firma del gerente',submitReview:'Enviar revisión',
    reviewSaved:'Revisión guardada',saveFailed:'No se pudo guardar la revisión',saving:'Guardando...',
    intro:`<section id="review-intro">
      <h1>Dublin Cleaners Evaluaciones Anuales de Empleados 2025 – Tu oportunidad para destacar</h1>
      <div class="intro-cards">
        <div class="info-card">
          <h2>Propósito</h2>
          <p>Destacar logros, vivir nuestros valores fundamentales y explicar por qué mereces un aumento mientras recibes comentarios para crecer.</p>
        </div>
        <div class="info-card">
          <h2>Valores fundamentales</h2>
          <ul class="values-list">
            <li>Responsabilidad</li>
            <li>Atención al detalle</li>
            <li>Trabajo en equipo</li>
            <li>Tomador de riesgos táctico</li>
            <li>Mejor que ayer</li>
            <li>Valorar la reputación</li>
          </ul>
        </div>
        <div class="info-card">
          <h2>Sistema de calificación y Proceso</h2>
          <div class="rating-badges">
            <span class="badge badge-gray">Por debajo de las expectativas</span>
            <span class="badge badge-green">Cumple con las expectativas</span>
            <span class="badge badge-gold">Supera las expectativas</span>
          </div>
          <p>(Asistencia y puntualidad, P1, tiene mayor peso)</p>
          <div class="process">
            <span>Revisiones de julio</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>enviar formulario</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>el gerente/asistente agrega notas</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>programar una reunión de 20 minutos (bloques de media hora) ≥ 1 semana después de la entrega</span>
          </div>
          <p>Programar fuera del horario habitual; se compensa si es día libre/fuera del turno.</p>
          <p>Informe a RRHH cuánto duró la reunión para que puedan agregar sus horas a UKG</p>
        </div>
      </div>
      <div class="callout">Los aumentos entran en vigor en el primer periodo de pago de agosto.</div>
    </section>`
  }
};
function t(key){
  if(config[key]&&config[key][lang])return config[key][lang];
  if(translations[lang]&&translations[lang][key])return translations[lang][key];
  return key;
}
function startLoading(){
  document.body.style.background='#fff';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.remove('hidden');
  loadingReviews=true;
}
function stopLoading(){
  document.body.style.background='';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.add('hidden');
  loadingReviews=false;
}
function show(id){
  if((id==='reviews' || id==='schedule') && !user){
    pendingSection=id;
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.getElementById('login').classList.remove('hidden');
    return;
  }
  document.getElementById('login').classList.add('hidden');
  document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
  if(id==='reviews'){
    startLoading();
    if(user){
      loadReviews();
      loadSavedReview();
    }
    loadQuestions();
  }else{
    if(id==='home'){
      const list=document.getElementById('reviewsList');
      if(list)list.innerHTML='';
    }
    document.getElementById(id).classList.remove('hidden');
  }
}
function applyTranslations(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.dataset.i18n;
    if(el.hasAttribute('data-i18n-placeholder'))el.placeholder=t(key);
    else if(el.hasAttribute('data-i18n-html'))el.innerHTML=t(key);
    else if(el.hasAttribute('data-i18n-alt'))el.alt=t(key);
    else el.textContent=t(key);
  });
  document.querySelectorAll('.dc-lang-toggle button').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.lang===lang);
  });
  const loginBtn=document.getElementById('navLoginBtn');
  if(loginBtn)loginBtn.textContent=user?t('logout'):t('login');
}
function init(){
  show('home');
  applyTranslations();
  loadQuestions();
  const revSection=document.getElementById('reviews');
  google.script.run.withSuccessHandler(c=>{config=c;loadSession();}).loadConfig();
}
function loadSession(){
  google.script.run.withSuccessHandler(u=>{
    if(u){
      user=u;
      lang=u.lang;
      localStorage.setItem('lang',lang);
      applyTranslations();
      showDevButton();
      loadReviews();
      show('home');
    }else{
      applyTranslations();
      showDevButton();
    }
  }).getSession();
}
function login(){
  const e=document.getElementById('userId').value;
  const p=document.getElementById('password').value;
  document.body.style.cursor='wait';
  setTimeout(()=>{document.body.style.cursor='';},3000);
  google.script.run
    .withSuccessHandler(r=>{
      if(r.success){
        user=r.user;
        lang=user.lang;
        localStorage.setItem('lang',lang);
        document.getElementById('login').classList.add('hidden');
        document.getElementById('navLoginBtn').textContent=t('logout');
        applyTranslations();
        showDevButton();
        loadReviews();
      const target=pendingSection||'reviews';
      pendingSection=null;
      show(target);
      }else{
        let msg='';
        if(r.error==='invalid_password')msg=t('invalidPwd');
        else if(r.error==='user_not_found')msg=t('noAccount');
        else msg=t('loginFail');
        alert(msg);
    }
    })
    .withFailureHandler(err=>{
      alert(err.message||t('loginFail'));
    })
    .login(e,p);
}

function navLogin(){
  const loginDiv=document.getElementById('login');
  if(user){
    if(typeof google!==
      'undefined' && google.script && google.script.run){
      google.script.run.logout();
    }
    user=null;
    reviews=[];
    loginDiv.classList.add('hidden');
    document.getElementById('navLoginBtn').textContent=t('login');
    show('home');
  }else{
    loginDiv.classList.toggle('hidden');
  }
}

function toggleLang(l){
  lang=l||'en';
  if(user) user.lang=lang;
  if(typeof google!=='undefined' && google.script && google.script.run){
    google.script.run.saveLang(lang);
  }
  localStorage.setItem('lang',lang);
  applyTranslations();
  renderReviews();
  renderQuestionList();
}
let reviews=[];
function loadReviews(){
  google.script.run.withSuccessHandler(r=>{
    reviews=r;
    renderReviews();
    fillSavedAnswers();
  }).listReviews();
}

function loadSavedReview(){
  if(!user || typeof google==='undefined' || !google.script || !google.script.run) return;
  google.script.run.withSuccessHandler(r=>{
    if(r){
      // replace existing saved review for selected year
      reviews=reviews.filter(rv=>!(rv.type==='SELF' && rv.employeeId==user.id && rv.data && Number(rv.data.year)==Number(selectedYear)));
      reviews.push(r);
    }
    fillSavedAnswers();
  }).getReviewByYear(selectedYear);
}
function renderReviews(){const c=document.getElementById('reviewsList');if(!c)return;c.innerHTML='';reviews.forEach(rv=>{const div=document.createElement('div');div.className='card';div.innerHTML='<b>'+rv.type+'</b> '+rv.status+'<br>'+JSON.stringify(rv.data);c.appendChild(div);});}

function showDevButton(){
  const btn=document.getElementById('devBtn');
  if(!btn)return;
  btn.classList.remove('hidden');
  btn.disabled=false;
}

function openDevPanel(){
  if(typeof google==='undefined' || !google.script || !google.script.run) return;
  google.script.run.withSuccessHandler(isDev=>{
    if(isDev){
      document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
      document.getElementById('devPanel').classList.remove('hidden');
    }else{
      alert('Not authorized');
    }
  }).isAuthorizedDev();
}

let questions=[];
function loadQuestions(){
  if(typeof google==='undefined'||!google.script||!google.script.run){
    questions=defaultQuestions;
    renderQuestionList();
    return;
  }
  google.script.run
    .withSuccessHandler(q=>{
      questions=(q&&q.length)?q:defaultQuestions;
      renderQuestionList();
    })
    .withFailureHandler(err=>{
      console.error('loadQuestions failed',err);
      questions=defaultQuestions;
      renderQuestionList();
    })
    .getQuestions();
}
function renderQuestionList(){
  const qd=document.getElementById('questionList');
  if(!qd)return;
  qd.innerHTML='';
  questions.forEach(q=>{
    const div=document.createElement('div');
    div.className='card q';
    div.dataset.id=q.id;
    let html='<label class="question-title">'+q[lang]+'</label>';
    if(q.rating!==false){
      html+='<div class="rating-group">'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="1"> 1 - '+t('below')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="2"> 2 - '+t('meets')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="3"> 3 - '+t('exceeds')+'</label>'
        +'</div>';
    }else{
      html+='<input type="hidden" class="rating" value="">';
    }
    if(Array.isArray(q.extras)){
      q.extras.forEach(ex=>{
        const lbl=ex['label_'+lang]||ex.label;
        html+='<label>'+lbl;
        if(ex.type==='textarea')html+='<textarea class="extra" data-sub="'+ex.id+'"></textarea>';
        else if(ex.type==='select'){
          html+='<select class="extra" data-sub="'+ex.id+'">';
          ex.options.forEach(o=>{html+='<option value="'+o+'">'+o+'</option>';});
          html+='</select>';
        }else html+='<input type="'+ex.type+'" class="extra" data-sub="'+ex.id+'">';
        html+='</label>';
      });
    }else if(q.extra==='textarea'){
      html+='<textarea class="extra"></textarea>';
    }else if(q.extra==='number'){
      html+='<input type="number" class="extra">';
    }
    div.innerHTML=html;
    qd.appendChild(div);
  });
  fillSavedAnswers();
  if(user&&user.role&&(['MANAGER','HR','DEV'].indexOf(user.role)!==-1)){
    document.getElementById('compAdjust').classList.remove('hidden');
  }
  if(loadingReviews){
    document.getElementById('reviews').classList.remove('hidden');
    stopLoading();
  }
  setupAutosave();
}

function fillSavedAnswers(){
  document.querySelectorAll('#questionList input.rating').forEach(r=>{r.checked=false;});
  document.querySelectorAll('#questionList .extra').forEach(e=>{e.value='';});
  document.querySelectorAll('#finalBlock input[name=finalExp]').forEach(r=>{r.checked=false;});
  document.getElementById('finalNotes').value='';
  document.getElementById('empSign').value='';
  document.getElementById('mgrSign').value='';
  currentReviewId=null;
  if(!user||!reviews||!reviews.length) return;
  const matches=reviews.filter(r=>
    r.type==='SELF' &&
    r.employeeId==user.id &&
    r.data && Number(r.data.year)==Number(selectedYear)
  );
  if(!matches.length) return;
  const rev=matches.sort((a,b)=>new Date(b.ts)-new Date(a.ts))[0];
  if(!rev.data || !rev.data.answers) return;
  currentReviewId=rev.id;
  const ans=rev.data.answers;
  Object.keys(ans).forEach(qid=>{
    const qDiv=document.querySelector('#questionList .q[data-id="'+qid+'"]');
    if(!qDiv) return;
    const val=ans[qid];
    if(val.score){
      const radio=qDiv.querySelector('input.rating[value="'+val.score+'"]');
      if(radio) radio.checked=true;
    }
    if(val.extra!==undefined){
      if(typeof val.extra==='object'){
        Object.keys(val.extra).forEach(k=>{
          const el=qDiv.querySelector('.extra[data-sub="'+k+'"]');
          if(el) el.value=val.extra[k];
        });
      }else{
        const el=qDiv.querySelector('.extra');
        if(el) el.value=val.extra;
      }
    }
  });
  if(rev.data.finalExpectation){
    const fe=rev.data.finalExpectation;
    if(fe.result){
      const r=document.querySelector('#finalBlock input[name=finalExp][value="'+fe.result+'"]');
      if(r) r.checked=true;
    }
    if(fe.notes) document.getElementById('finalNotes').value=fe.notes;
    if(fe.empSign) document.getElementById('empSign').value=fe.empSign.name||'';
    if(fe.mgrSign) document.getElementById('mgrSign').value=fe.mgrSign.name||'';
  }
}
function calcPct(){const c=parseFloat(document.getElementById('curWage').value||0);const n=parseFloat(document.getElementById('newWage').value||0);const pct=document.getElementById('pctInc');pct.textContent=c?(((n-c)/c)*100).toFixed(2):'0';}
function gatherAnswers(){
  const ans={};
  document.querySelectorAll('#questionList .q').forEach(d=>{
    const id=d.dataset.id;
    const ratingEl=d.querySelector('input.rating:checked, select.rating');
    const rating=ratingEl?ratingEl.value:'';
    const extraEls=d.querySelectorAll('.extra');
    let extra='';
    if(extraEls.length===1 && !extraEls[0].dataset.sub){
      extra=extraEls[0].value||'';
    }else if(extraEls.length>0){
      extra={};
      extraEls.forEach(e=>{extra[e.dataset.sub||'value']=e.value;});
    }
    ans[id]={score:rating,extra:extra};
  });
  return ans;
}
function gatherReviewData(){
  const answers=gatherAnswers();
  let comp=null;
  const adjBlock=document.getElementById('compAdjust');
  if(adjBlock&&!adjBlock.classList.contains('hidden')){
    comp={employeeId:user.id,current:document.getElementById('curWage').value,new:document.getElementById('newWage').value,pct:document.getElementById('pctInc').textContent};
  }
  const finalExp={result:document.querySelector('input[name=finalExp]:checked')?.value||'',notes:document.getElementById('finalNotes').value,empSign:{name:document.getElementById('empSign').value,ts:new Date().toISOString()},mgrSign:{name:document.getElementById('mgrSign').value,ts:new Date().toISOString()}};
  return {answers,comp,finalExp};
}

let autosaveTimeout;
function scheduleAutosave(){
  clearTimeout(autosaveTimeout);
  autosaveTimeout=setTimeout(autosaveReview,1000);
}
function autosaveReview(){
  if(!user) return;
  const data=gatherReviewData();
  const review={id:currentReviewId,employeeId:user.id,type:'SELF',status:'DRAFT',data:{year:selectedYear,answers:data.answers,finalExpectation:data.finalExp}};
  google.script.run.withFailureHandler(e=>console.error('autosave failed',e)).saveFullReview(review,data.comp);
}
function setupAutosave(){
  const form=document.getElementById('reviewForm');
  if(!form)return;
  const fields=form.querySelectorAll('input,textarea,select');
  fields.forEach(f=>{
    f.removeEventListener('input',scheduleAutosave);
    f.removeEventListener('change',scheduleAutosave);
    f.addEventListener('input',scheduleAutosave);
    f.addEventListener('change',scheduleAutosave);
  });
  window.addEventListener('beforeunload',autosaveReview);
}
function submitReview(){
  const data=gatherReviewData();
  const review={id:currentReviewId,employeeId:user.id,type:'SELF',status:'SUBMITTED',data:{year:selectedYear,answers:data.answers,finalExpectation:data.finalExp}};
  document.getElementById('submitMsg').textContent='Saved';
  google.script.run.withSuccessHandler(r=>{
    currentReviewId=r.id;
    loadReviews();
  }).saveFullReview(review,data.comp);
}

function addNewUser(){
  const uid=document.getElementById('newUserId').value;
  const role=document.getElementById('newUserRole').value;
  const pwd=document.getElementById('newUserPwd').value;
  google.script.run
    .withSuccessHandler(()=>{
      alert('Account created');
      document.getElementById('newUserId').value='';
      document.getElementById('newUserRole').value='';
      document.getElementById('newUserPwd').value='';
    })
    .withFailureHandler(err=>{
      alert('Failed to create account: '+err.message);
    })
    .addNewUser({userId:uid,role:role,password:pwd});
}
document.addEventListener('DOMContentLoaded',init);
</script>
</head>
<body>
<header class="dc-header">
  <img src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png" alt="Logo" class="dc-logo">
  <h1 class="dc-title" data-i18n="navTitle">Employee Annual Reviews</h1>
  <div class="dc-actions">
    <div class="dc-lang-toggle">
      <button data-lang="en" onclick="toggleLang('en')">EN</button>
      <button data-lang="es" onclick="toggleLang('es')">ES</button>
    </div>
    <button id="devBtn" class="dc-btn" onclick="openDevPanel()">Dev</button>
  </div>
</header>
<nav class="dc-nav">
  <button onclick="show('home')" data-i18n="home">Home</button>
  <button onclick="show('reviews')" data-i18n="reviews">Reviews</button>
  <button onclick="show('schedule')" data-i18n="schedule">Schedule</button>
  <button id="navLoginBtn" class="dc-btn" onclick="navLogin()">Login</button>
</nav>
<main class="dc-container">
<div id="loadingBar" class="loading-bar hidden"><span></span></div>
<section id="home" class="dc-card hidden">
<h2 data-i18n="welcomeTitle">Welcome to the Employee Review Portal</h2>
<p data-i18n="welcomeMsg">Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.</p>
<div id="reviewsList"></div>
</section>
<section id="reviews" class="dc-card hidden">
<form id="reviewForm" onsubmit="submitReview();return false;">
<div data-i18n="intro" data-i18n-html></div>
<div id="questionList"></div>
<div id="compAdjust" class="dc-card hidden">
<label><span data-i18n="curWage">Current Wage</span><input type="number" id="curWage"></label>
<label><span data-i18n="newWage">New Wage</span><input type="number" id="newWage" oninput="calcPct()"></label>
<div><span data-i18n="pctIncrease">% Increase:</span> <span id="pctInc">0</span>%</div>
</div>
<div id="finalBlock" class="dc-card">
<p data-i18n="finalExpTitle">Final Performance Expectation</p>
<label><input type="radio" name="finalExp" value="below"> <span data-i18n="belowExp">Below Expectations</span></label>
<label><input type="radio" name="finalExp" value="meets"> <span data-i18n="meetsExp">Meets Expectations</span></label>
<label><input type="radio" name="finalExp" value="exceeds"> <span data-i18n="exceedsExp">Exceeds Expectations</span></label>
<textarea id="finalNotes" data-i18n="notesPlaceholder" data-i18n-placeholder placeholder="Notes"></textarea>
<small data-i18n="contactQuestions">Contact Sea Khun with questions.</small>
</div>
<div class="dc-card">
<label><span data-i18n="empSignature">Employee Signature</span><input type="text" id="empSign"></label>
<label><span data-i18n="mgrSignature">Manager Signature</span><input type="text" id="mgrSign"></label>
</div>
<button class="dc-btn" type="submit" data-i18n="submitReview">Submit Review</button><span id="submitMsg"></span>
</form>
</section>
<section id="schedule" class="dc-card hidden">
<p data-i18n="comingSoon">Coming soon...</p>
</section>
<section id="devPanel" class="dc-card hidden">
  <h3>Admin Panel</h3>
  <label>UserID<input type="text" id="newUserId"></label>
  <label>Role<input type="text" id="newUserRole"></label>
  <label>Password<input type="password" id="newUserPwd"></label>
  <button class="dc-btn" onclick="addNewUser()">Add User</button>
</section>
<div id="login" class="dc-card hidden">
<label><span data-i18n="userId">User ID</span><input type="text" id="userId" data-i18n="userId" data-i18n-placeholder></label>
<label><span data-i18n="password">Password</span><input type="password" id="password" data-i18n="password" data-i18n-placeholder></label>
<button class="dc-btn" onclick="login()" data-i18n="login">Login</button>
</div>
</main>
<footer class="dc-footer">Follow us on  @dublincleaners  (Facebook, Instagram, TikTok, X)</footer>
</body>
</html>
