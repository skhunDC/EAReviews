<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Employee Reviews</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
h1,h2{font-family:'Inter',Arial,sans-serif;}
body{font-family:'Inter',Roboto,Arial,sans-serif;margin:0;padding:0;background:linear-gradient(135deg,#f6f8fa 0%,#eaf4ff 100%);color:#333;font-size:1rem;line-height:1.6;}
h1{font-size:clamp(1.75rem,4vw,2.5rem);margin:0 0 1rem 0;}
h2{font-size:1.25rem;margin-top:0;color:#0A5C30;}
#review-intro h1{text-align:center;color:#0A5C30;font-weight:700;margin-bottom:1.5rem;}
#review-intro{max-width:900px;margin:auto;padding:2rem;background:#fefdf9;color:#333;}
#review-intro .intro-cards{display:flex;flex-wrap:wrap;gap:1.5rem;}
#review-intro .info-card{background:#fff;border-radius:1rem;box-shadow:0 4px 12px rgba(0,0,0,0.08);padding:1.5rem;flex:1 1 100%;animation:slideUp 0.5s ease forwards;}
@media(min-width:640px){#review-intro .info-card{flex-basis:calc(50% - 0.75rem);}}
.values-list{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));}
.values-list li{display:inline-block;background:#0A5C30;color:#fff;padding:0.2rem 0.75rem;border-radius:9999px;font-size:0.9rem;margin:0.2rem;text-align:center;}
.rating-badges{display:flex;gap:0.5rem;margin-bottom:0.5rem;flex-wrap:wrap;}
.badge{display:inline-block;padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.9rem;color:#fff;}
.badge-gray{background:#888;}
.badge-green{background:#0A5C30;}
.badge-gold{background:#C9A14A;color:#000;}
.process{display:flex;flex-wrap:wrap;align-items:center;gap:0.3rem;margin-bottom:0.5rem;font-size:0.9rem;}
.process svg{width:12px;height:12px;fill:none;stroke:#0A5C30;stroke-width:2;}
.callout{margin-top:1rem;background:#C9A14A1A;border-left:4px solid #C9A14A;padding:0.75rem;font-size:0.9rem;}
@keyframes slideUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
nav{display:flex;gap:10px;background:#0A5C30;color:white;padding:10px;align-items:center;position:relative;z-index:50;}
nav button{background:none;border:none;color:white;font-size:16px;cursor:pointer;padding:6px 12px;}
.lang-switch{display:flex;align-items:center;margin-left:auto;gap:4px;}
.logo{width:125px;height:125px;}
.nav-title{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:24px;font-weight:bold;}
.switch{position:relative;display:inline-block;width:40px;height:24px;}
.switch input{opacity:0;width:0;height:0;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;transition:.4s;border-radius:9999px;}
.slider:before{position:absolute;content:"";height:20px;width:20px;left:2px;bottom:2px;background:white;transition:.4s;border-radius:50%;}
.switch input:checked + .slider{background:#059669;}
.switch input:checked + .slider:before{transform:translateX(16px);}
#devPanel{z-index:40;}
section{padding:20px;}
#login{background:linear-gradient(135deg,#f6f8fa 0%,#eaf4ff 100%);}
#reviewForm{max-width:900px;margin:auto;padding:2rem;background:#fefdf9;color:#333;}
.question-title{display:block;font-size:1.25rem;color:#0A5C30;margin-bottom:0.5rem;font-weight:600;}
.card{background:#fff;padding:1.5rem;margin-bottom:1.5rem;border-radius:1rem;box-shadow:0 4px 12px rgba(0,0,0,0.08);animation:slideUp 0.5s ease forwards;}
.hidden{display:none;}
label{display:block;margin-top:10px;}
input[type=text],textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:4px;}
select{padding:8px;}
 .rating-group label{display:inline-block;margin-right:10px;}
button.primary{background:#0A5C30;color:white;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;}
#submitMsg{margin-left:8px;font-weight:bold;}
/* Dropdown styles */
.dropdown{position:relative;}
.dropdown-content{display:none;position:absolute;top:100%;left:0;background:#0A5C30;color:white;min-width:80px;z-index:10;}
.dropdown-content button{background:none;border:none;color:white;cursor:pointer;display:block;width:100%;padding:6px 12px;text-align:left;}
.dropdown-content.show{display:block;}
/* Loading bar styles */
.loading-bar{height:4px;background:#eee;position:relative;overflow:hidden;}
.loading-bar span{display:block;height:100%;background:#0A5C30;width:100%;animation:loadAnim 1.2s linear infinite;}
@keyframes loadAnim{from{transform:translateX(-100%);}to{transform:translateX(100%);}}
</style>
<script>
let user=null,config={},lang=localStorage.getItem('lang')||'en';
let loadingReviews=false;
let pendingSection=null;
let currentReviewId=null;
let selectedYear=new Date().getFullYear();

const defaultQuestions=[
  {id:'attendance',en:'Attendance & Punctuality',es:'Asistencia y Puntualidad',extras:[
    {id:'absences',label:'Absences without notice (days)',label_es:'Ausencias sin aviso (días)',type:'number'},
    {id:'late',label:'Late arrivals (days)',label_es:'Llegadas tarde (días)',type:'number'},
    {id:'comments',label:'Comments',label_es:'Comentarios',type:'textarea'}]},
  {id:'performance',en:'Performance Improvements: What did you do more, better, or more efficiently last year, up till now?',es:'Mejoras de rendimiento',extra:'textarea'},
  {id:'values',en:'Living Our Core Values: How have you embodied our core values? Provide specific examples.',es:'Vivir nuestros valores',extra:'textarea'},
  {id:'growth',en:'Personal Growth: How did you improve your knowledge or skills last year, up till now?',es:'Crecimiento personal',extra:'textarea'},
  {id:'learning',en:'Learning New Skills: Did you take or create opportunities to learn a new skill or enhance an existing one?',es:'Aprendizaje de nuevas habilidades',extra:'textarea'},
  {id:'team',en:'Team Support: How did you support your teammates in developing their skills?',es:'Apoyo al equipo',extra:'textarea'},
  {id:'flexibility',en:'Flexibility: When asked to cover for others, did you agree? Share an example.',es:'Flexibilidad',extra:'textarea'},
  {id:'initiative',en:'Initiative: Describe a time you proactively improved a process or solved a problem without being asked.',es:'Iniciativa',extra:'textarea'},
  {id:'proactive',en:'Proactive Contributions: How did you proactively use downtime to tackle additional tasks?',es:'Contribuciones proactivas',extra:'textarea'},
  {id:'innovation',en:'Innovation & Process Improvement: Have you suggested or implemented improvements to our processes, services, or workplace? Describe your idea and its impact.',es:'Innovaci\u00f3n y mejora de procesos',extra:'textarea'},
  {id:'crossshadow',en:'Cross Shadowing Program Participation',es:'Programa Cross Shadowing',rating:false,extras:[
    {id:'participation',label:'Did you participate? (Yes/No/Partial)',label_es:'¿Participaste? (Sí/No/Parcial)',type:'select',options:['Yes','No','Partial']},
    {id:'comments',label:'Comments',label_es:'Comentarios',type:'textarea'}]},
  {id:'future',en:'Future Interests: Is there another role or skill you\u2019d like to explore in the future?',es:'Intereses futuros',rating:false,extra:'textarea'}
];
const translations={
  en:{
    home:'Home',reviews:'Reviews',schedule:'Schedule',navTitle:'Employee Annual Reviews',
    welcomeTitle:'Welcome to the Employee Review Portal',
    welcomeMsg:'Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.',
    comingSoon:'Coming soon...',userId:'User ID',password:'Password',login:'Login',logout:'Logout',
    loginFail:'Login failed',invalidPwd:'Invalid password.',
    noAccount:'Account not found. Please reach out to Sea Khun to be added.',
    curWage:'Current Wage',newWage:'New Wage',pctIncrease:'% Increase:',
    finalExpTitle:'Final Performance Expectation',belowExp:'Below Expectations',meetsExp:'Meets Expectations',exceedsExp:'Exceeds Expectations',
    below:'Below',meets:'Meets',exceeds:'Exceeds',
    notesPlaceholder:'Notes',contactQuestions:'Contact Sea Khun with questions.',empSignature:'Employee Signature',mgrSignature:'Manager Signature',submitReview:'Submit Review',
    reviewSaved:'Review saved',saveFailed:'Failed to save review',saving:'Saving...',
    scheduleBtn:'Schedule Review Meeting',
    bookPrompt:'Book this time?',
    cancel:'Cancel',
    conflict:'Slot already booked',
    selDate:'Select Date',
    selTime:'Select Time',
    book:'Book',
    chooseTime:'Please choose date and time',
    bookOk:'Meeting booked',
    error:'Error occurred',
    intro:`<section id="review-intro">
      <h1>Your Opportunity to Shine</h1>
      <div class="intro-cards">
        <div class="info-card">
          <h2>Purpose</h2>
          <p>Highlight achievements, live our core values, and explain why you deserve a pay increase while receiving growth feedback.</p>
        </div>
        <div class="info-card">
          <h2>Core Values</h2>
          <ul class="values-list">
            <li>Accountable</li>
            <li>Attention to Details</li>
            <li>Team Player</li>
            <li>Tactical Risk Taker</li>
            <li>Better than Yesterday</li>
            <li>Value Reputation</li>
          </ul>
        </div>
        <div class="info-card">
          <h2>Rating System &amp; Process</h2>
          <div class="rating-badges">
            <span class="badge badge-gray">Below Expectations</span>
            <span class="badge badge-green">Meets Expectations</span>
            <span class="badge badge-gold">Exceeds Expectations</span>
          </div>
          <p>(Attendance &amp; punctuality, Q1, is weighted higher)</p>
          <div class="process">
            <span>July reviews</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>submit form</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>Manager/Assistant adds notes</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>schedule 20-min meeting (half-hour slots) ≥ 1 week after submission</span>
          </div>
          <p>Schedule outside regular hours; compensated if on day off/outside shift.</p>
          <p>Please Message HR about how long your meeting was so they can Add your hours into UKG</p>
        </div>
      </div>
      <div class="callout">Raises take effect on the first pay period in August.</div>
    </section>`
  },
  es:{
    home:'Inicio',reviews:'Reseñas',schedule:'Agenda',navTitle:'Revisiones Anuales de Empleados',
    welcomeTitle:'Bienvenido al Portal de Evaluaciones',
    welcomeMsg:'Seleccione una opción en la barra de navegación para ver sus evaluaciones o programar una reunión. Use el botón de idioma para cambiar entre inglés y español.',
    comingSoon:'Próximamente...',userId:'ID de usuario',password:'Contraseña',login:'Iniciar sesión',logout:'Cerrar sesión',
    loginFail:'Error al iniciar sesión',invalidPwd:'Contraseña inválida.',
    noAccount:'Cuenta no encontrada. Por favor contacte a Sea Khun para ser agregado.',
    curWage:'Salario actual',newWage:'Nuevo salario',pctIncrease:'% Aumento:',
    finalExpTitle:'Expectativa de desempeño final',belowExp:'Debajo de las expectativas',meetsExp:'Cumple con las expectativas',exceedsExp:'Supera las expectativas',
    below:'Debajo',meets:'Cumple',exceeds:'Supera',
    notesPlaceholder:'Notas',contactQuestions:'Contacte a Sea Khun con preguntas.',empSignature:'Firma del empleado',mgrSignature:'Firma del gerente',submitReview:'Enviar revisión',
    reviewSaved:'Revisión guardada',saveFailed:'No se pudo guardar la revisión',saving:'Guardando...',
    scheduleBtn:'Agendar Reunión de Revisión',
    bookPrompt:'¿Reservar esta hora?',
    cancel:'Cancelar',
    conflict:'Horario no disponible',
    selDate:'Seleccionar fecha',
    selTime:'Seleccionar hora',
    book:'Agendar',
    chooseTime:'Seleccione fecha y hora',
    bookOk:'Reunión programada',
    error:'Ocurrió un error',
    intro:`<section id="review-intro">
      <h1>Tu oportunidad para destacar</h1>
      <div class="intro-cards">
        <div class="info-card">
          <h2>Propósito</h2>
          <p>Destacar logros, vivir nuestros valores fundamentales y explicar por qué mereces un aumento mientras recibes comentarios para crecer.</p>
        </div>
        <div class="info-card">
          <h2>Valores fundamentales</h2>
          <ul class="values-list">
            <li>Responsabilidad</li>
            <li>Atención al detalle</li>
            <li>Trabajo en equipo</li>
            <li>Tomador de riesgos táctico</li>
            <li>Mejor que ayer</li>
            <li>Valorar la reputación</li>
          </ul>
        </div>
        <div class="info-card">
          <h2>Sistema de calificación y Proceso</h2>
          <div class="rating-badges">
            <span class="badge badge-gray">Por debajo de las expectativas</span>
            <span class="badge badge-green">Cumple con las expectativas</span>
            <span class="badge badge-gold">Supera las expectativas</span>
          </div>
          <p>(Asistencia y puntualidad, P1, tiene mayor peso)</p>
          <div class="process">
            <span>Revisiones de julio</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>enviar formulario</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>el gerente/asistente agrega notas</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>programar una reunión de 20 minutos (bloques de media hora) ≥ 1 semana después de la entrega</span>
          </div>
          <p>Programar fuera del horario habitual; se compensa si es día libre/fuera del turno.</p>
          <p>Informe a RRHH cuánto duró la reunión para que puedan agregar sus horas a UKG</p>
        </div>
      </div>
      <div class="callout">Los aumentos entran en vigor en el primer periodo de pago de agosto.</div>
    </section>`
  }
};
function t(key){
  if(config[key]&&config[key][lang])return config[key][lang];
  if(translations[lang]&&translations[lang][key])return translations[lang][key];
  return key;
}
function startLoading(){
  document.body.style.background='#fff';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.remove('hidden');
  loadingReviews=true;
}
function stopLoading(){
  document.body.style.background='';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.add('hidden');
  loadingReviews=false;
}
function show(id){
  if((id==='reviews' || id==='schedule') && !user){
    pendingSection=id;
    document.querySelectorAll('body>section').forEach(s=>s.classList.add('hidden'));
    document.getElementById('login').classList.remove('hidden');
    return;
  }
  document.getElementById('login').classList.add('hidden');
  document.querySelectorAll('body>section').forEach(s=>s.classList.add('hidden'));
  if(id==='reviews'){
    startLoading();
    if(user){
      loadReviews();
      loadSavedReview();
    }
    loadQuestions();
  }else if(id==='schedule'){
    initCalendar();
    document.getElementById(id).classList.remove('hidden');
  }else{
    if(id==='home'){
      const list=document.getElementById('reviewsList');
      if(list)list.innerHTML='';
    }
    document.getElementById(id).classList.remove('hidden');
  }
}
function applyTranslations(){
  document.querySelectorAll('[data-i18n-key]').forEach(el=>{
    const key=el.dataset.i18nKey;
    if(el.hasAttribute('data-i18n-placeholder'))el.placeholder=t(key);
    else if(el.hasAttribute('data-i18n-html'))el.innerHTML=t(key);
    else if(el.hasAttribute('data-i18n-alt'))el.alt=t(key);
    else el.textContent=t(key);
  });
  const toggle=document.getElementById('langToggle');
  if(toggle)toggle.checked=lang==='es';
  const loginBtn=document.getElementById('navLoginBtn');
  if(loginBtn)loginBtn.textContent=user?t('logout'):t('login');
}
function init(){
  show('home');
  applyTranslations();
  loadQuestions();
  initCalendar();
  const revSection=document.getElementById('reviews');
  google.script.run.withSuccessHandler(c=>{config=c;loadSession();}).loadConfig();
}
function loadSession(){
  google.script.run.withSuccessHandler(u=>{
    if(u){
      user=u;
      lang=u.lang;
      localStorage.setItem('lang',lang);
      applyTranslations();
      showDevButton();
      show('home');
    }else{
      applyTranslations();
      showDevButton();
    }
  }).getSession();
}
function login(){
  const e=document.getElementById('userId').value;
  const p=document.getElementById('password').value;
  document.body.style.cursor='wait';
  startLoading();
  google.script.run
    .withSuccessHandler(r=>{
      document.body.style.cursor='';
      stopLoading();
      if(r.success){
        user=r.user;
        lang=user.lang;
        localStorage.setItem('lang',lang);
        document.getElementById('login').classList.add('hidden');
        document.getElementById('navLoginBtn').textContent=t('logout');
        applyTranslations();
        showDevButton();
        loadReviews();
      const target=pendingSection||'reviews';
      pendingSection=null;
      show(target);
      }else{
        let msg='';
        if(r.error==='invalid_password')msg=t('invalidPwd');
        else if(r.error==='user_not_found')msg=t('noAccount');
        else msg=t('loginFail');
        alert(msg);
    }
    })
    .withFailureHandler(err=>{
      document.body.style.cursor='';
      stopLoading();
      alert(err.message||t('loginFail'));
    })
    .login(e,p);
}

function navLogin(){
  const loginDiv=document.getElementById('login');
  if(user){
    if(typeof google!==
      'undefined' && google.script && google.script.run){
      google.script.run.logout();
    }
    user=null;
    reviews=[];
    loginDiv.classList.add('hidden');
    document.getElementById('navLoginBtn').textContent=t('login');
    show('home');
  }else{
    loginDiv.classList.toggle('hidden');
    // hide dev panel when showing login
    const dev=document.getElementById('devPanel');
    if(dev)dev.classList.add('hidden');
  }
}

function toggleLang(){
  lang=document.getElementById('langToggle').checked?'es':'en';
  if(user) user.lang=lang;
  if(typeof google!=='undefined' && google.script && google.script.run){
    google.script.run.saveLang(lang);
  }
  localStorage.setItem('lang',lang);
  applyTranslations();
  renderReviews();
  renderQuestionList();
}
let reviews=[];
function loadReviews(){
  google.script.run.withSuccessHandler(r=>{
    reviews=r;
    renderReviews();
    fillSavedAnswers();
  }).listReviews();
}

function loadSavedReview(){
  if(!user || typeof google==='undefined' || !google.script || !google.script.run) return;
  google.script.run.withSuccessHandler(r=>{
    if(r){
      // replace existing saved review for selected year
      reviews=reviews.filter(rv=>!(rv.type==='SELF' && rv.employeeId==user.id && rv.data && Number(rv.data.year)==Number(selectedYear)));
      reviews.push(r);
    }
    fillSavedAnswers();
  }).getReviewByYear(selectedYear);
}
function renderReviews(){const c=document.getElementById('reviewsList');if(!c)return;c.innerHTML='';reviews.forEach(rv=>{const div=document.createElement('div');div.className='card';div.innerHTML='<b>'+rv.type+'</b> '+rv.status+'<br>'+JSON.stringify(rv.data);c.appendChild(div);});}

function showDevButton(){
  const btn=document.getElementById('devBtn');
  if(!btn)return;
  btn.classList.remove('hidden');
  btn.disabled=false;
}

function openDevPanel(){
  if(typeof google==='undefined' || !google.script || !google.script.run) return;
  google.script.run.withSuccessHandler(isDev=>{
    if(isDev){
      document.querySelectorAll('body>section').forEach(s=>s.classList.add('hidden'));
      // hide login form if visible
      const loginDiv=document.getElementById('login');
      if(loginDiv) loginDiv.classList.add('hidden');
      document.getElementById('devPanel').classList.remove('hidden');
    }else{
      alert('Not authorized');
    }
  }).isAuthorizedDev();
}

let questions=[];
function loadQuestions(){
  if(typeof google==='undefined'||!google.script||!google.script.run){
    questions=defaultQuestions;
    renderQuestionList();
    return;
  }
  google.script.run
    .withSuccessHandler(q=>{
      questions=(q&&q.length)?q:defaultQuestions;
      renderQuestionList();
    })
    .withFailureHandler(err=>{
      console.error('loadQuestions failed',err);
      questions=defaultQuestions;
      renderQuestionList();
    })
    .getQuestions();
}
function renderQuestionList(){
  const qd=document.getElementById('questionList');
  if(!qd)return;
  qd.innerHTML='';
  questions.forEach(q=>{
    const div=document.createElement('div');
    div.className='card q';
    div.dataset.id=q.id;
    let html='<label class="question-title">'+q[lang]+'</label>';
    if(q.rating!==false){
      html+='<div class="rating-group">'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="1"> 1 - '+t('below')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="2"> 2 - '+t('meets')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="3"> 3 - '+t('exceeds')+'</label>'
        +'</div>';
    }else{
      html+='<input type="hidden" class="rating" value="">';
    }
    if(Array.isArray(q.extras)){
      q.extras.forEach(ex=>{
        const lbl=ex['label_'+lang]||ex.label;
        html+='<label>'+lbl;
        if(ex.type==='textarea')html+='<textarea class="extra" data-sub="'+ex.id+'"></textarea>';
        else if(ex.type==='select'){
          html+='<select class="extra" data-sub="'+ex.id+'">';
          ex.options.forEach(o=>{html+='<option value="'+o+'">'+o+'</option>';});
          html+='</select>';
        }else html+='<input type="'+ex.type+'" class="extra" data-sub="'+ex.id+'">';
        html+='</label>';
      });
    }else if(q.extra==='textarea'){
      html+='<textarea class="extra"></textarea>';
    }else if(q.extra==='number'){
      html+='<input type="number" class="extra">';
    }
    div.innerHTML=html;
    qd.appendChild(div);
  });
  fillSavedAnswers();
  if(user&&user.role&&(['MANAGER','HR','DEV'].indexOf(user.role)!==-1)){
    document.getElementById('compAdjust').classList.remove('hidden');
  }
  if(loadingReviews){
    document.getElementById('reviews').classList.remove('hidden');
    stopLoading();
  }
  setupAutosave();
}

function fillSavedAnswers(){
  document.querySelectorAll('#questionList input.rating').forEach(r=>{r.checked=false;});
  document.querySelectorAll('#questionList .extra').forEach(e=>{e.value='';});
  document.querySelectorAll('#finalBlock input[name=finalExp]').forEach(r=>{r.checked=false;});
  document.getElementById('finalNotes').value='';
  document.getElementById('empSign').value='';
  document.getElementById('mgrSign').value='';
  currentReviewId=null;
  if(!user||!reviews||!reviews.length) return;
  const matches=reviews.filter(r=>
    r.type==='SELF' &&
    r.employeeId==user.id &&
    r.data && Number(r.data.year)==Number(selectedYear)
  );
  if(!matches.length) return;
  const rev=matches.sort((a,b)=>new Date(b.ts)-new Date(a.ts))[0];
  if(!rev.data || !rev.data.answers) return;
  currentReviewId=rev.id;
  const ans=rev.data.answers;
  Object.keys(ans).forEach(qid=>{
    const qDiv=document.querySelector('#questionList .q[data-id="'+qid+'"]');
    if(!qDiv) return;
    const val=ans[qid];
    if(val.score){
      const radio=qDiv.querySelector('input.rating[value="'+val.score+'"]');
      if(radio) radio.checked=true;
    }
    if(val.extra!==undefined){
      if(typeof val.extra==='object'){
        Object.keys(val.extra).forEach(k=>{
          const el=qDiv.querySelector('.extra[data-sub="'+k+'"]');
          if(el) el.value=val.extra[k];
        });
      }else{
        const el=qDiv.querySelector('.extra');
        if(el) el.value=val.extra;
      }
    }
  });
  if(rev.data.finalExpectation){
    const fe=rev.data.finalExpectation;
    if(fe.result){
      const r=document.querySelector('#finalBlock input[name=finalExp][value="'+fe.result+'"]');
      if(r) r.checked=true;
    }
    if(fe.notes) document.getElementById('finalNotes').value=fe.notes;
    if(fe.empSign) document.getElementById('empSign').value=fe.empSign.name||'';
    if(fe.mgrSign) document.getElementById('mgrSign').value=fe.mgrSign.name||'';
  }
}
function calcPct(){const c=parseFloat(document.getElementById('curWage').value||0);const n=parseFloat(document.getElementById('newWage').value||0);const pct=document.getElementById('pctInc');pct.textContent=c?(((n-c)/c)*100).toFixed(2):'0';}
function gatherAnswers(){
  const ans={};
  document.querySelectorAll('#questionList .q').forEach(d=>{
    const id=d.dataset.id;
    const ratingEl=d.querySelector('input.rating:checked, select.rating');
    const rating=ratingEl?ratingEl.value:'';
    const extraEls=d.querySelectorAll('.extra');
    let extra='';
    if(extraEls.length===1 && !extraEls[0].dataset.sub){
      extra=extraEls[0].value||'';
    }else if(extraEls.length>0){
      extra={};
      extraEls.forEach(e=>{extra[e.dataset.sub||'value']=e.value;});
    }
    ans[id]={score:rating,extra:extra};
  });
  return ans;
}
function gatherReviewData(){
  const answers=gatherAnswers();
  let comp=null;
  const adjBlock=document.getElementById('compAdjust');
  if(adjBlock&&!adjBlock.classList.contains('hidden')){
    comp={employeeId:user.id,current:document.getElementById('curWage').value,new:document.getElementById('newWage').value,pct:document.getElementById('pctInc').textContent};
  }
  const finalExp={result:document.querySelector('input[name=finalExp]:checked')?.value||'',notes:document.getElementById('finalNotes').value,empSign:{name:document.getElementById('empSign').value,ts:new Date().toISOString()},mgrSign:{name:document.getElementById('mgrSign').value,ts:new Date().toISOString()}};
  return {answers,comp,finalExp};
}

let autosaveTimeout;
let submitMsgTimeout;
function scheduleAutosave(){
  clearTimeout(autosaveTimeout);
  autosaveTimeout=setTimeout(autosaveReview,1000);
}
function autosaveReview(){
  if(!user) return;
  const data=gatherReviewData();
  const review={id:currentReviewId,employeeId:user.id,type:'SELF',status:'DRAFT',data:{year:selectedYear,answers:data.answers,finalExpectation:data.finalExp}};
  google.script.run.withFailureHandler(e=>console.error('autosave failed',e)).saveFullReview(review,data.comp);
}
function setupAutosave(){
  const form=document.getElementById('reviewForm');
  if(!form)return;
  const fields=form.querySelectorAll('input,textarea,select');
  fields.forEach(f=>{
    f.removeEventListener('input',scheduleAutosave);
    f.removeEventListener('change',scheduleAutosave);
    f.addEventListener('input',scheduleAutosave);
    f.addEventListener('change',scheduleAutosave);
  });
  window.addEventListener('beforeunload',autosaveReview);
}
function submitReview(){
  const data=gatherReviewData();
  const review={id:currentReviewId,employeeId:user.id,type:'SELF',status:'SUBMITTED',data:{year:selectedYear,answers:data.answers,finalExpectation:data.finalExp}};
  const msgEl=document.getElementById('submitMsg');
  msgEl.textContent='Saved';
  clearTimeout(submitMsgTimeout);
  submitMsgTimeout=setTimeout(()=>{msgEl.textContent='';},5000);
  google.script.run.withSuccessHandler(r=>{
    currentReviewId=r.id;
    loadReviews();
  }).saveFullReview(review,data.comp);
}

function addNewUser(){
  const uid=document.getElementById('newUserId').value;
  const role=document.getElementById('newUserRole').value;
  const pwd=document.getElementById('newUserPwd').value;
  google.script.run
    .withSuccessHandler(()=>{
      alert('Account created');
      document.getElementById('newUserId').value='';
      document.getElementById('newUserRole').value='';
      document.getElementById('newUserPwd').value='';
    })
    .withFailureHandler(err=>{
      alert('Failed to create account: '+err.message);
    })
    .addNewUser({userId:uid,role:role,password:pwd});
}

// ---- Simple Scheduling -----
function initCalendar(){
  // no-op kept for compatibility
}
async function bookSimple(){
  const d=document.getElementById('selDate').value;
  const t=document.getElementById('selTime').value;
  if(!d||!t){alert(t('chooseTime'));return;}
  const start=new Date(d+'T'+t);
  const end=new Date(start.getTime()+30*60*1000);
  const resp=await fetch('book',{method:'POST',body:JSON.stringify({start:start.toISOString(),end:end.toISOString()})});
  const msg=document.getElementById('schedMsg');
  if(resp.ok){
    msg.textContent=t('bookOk');
    msg.className='text-green-700';
  }else if(resp.status===409){
    msg.textContent=t('conflict');
    msg.className='text-red-700';
  }else{
    msg.textContent=t('error');
    msg.className='text-red-700';
  }
}
document.addEventListener('DOMContentLoaded',init);
</script>
</head>
<body>
<nav>
<img src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png" alt="Logo" class="logo">
<button onclick="show('home')" data-i18n-key="home">Home</button>
<button onclick="show('reviews')" data-i18n-key="reviews">Reviews</button>
<button onclick="show('schedule')" data-i18n-key="schedule">Schedule</button>
<div class="nav-title" data-i18n-key="navTitle">Employee Annual Reviews</div>
<div class="lang-switch">
  <span>EN</span>
  <label class="switch"><input type="checkbox" id="langToggle" onchange="toggleLang()"><span class="slider"></span></label>
  <span>ES</span>
</div>
<button id="navLoginBtn" onclick="navLogin()">Login</button>
<button id="devBtn" onclick="openDevPanel()">Dev</button>
</nav>
<div id="loadingBar" class="loading-bar hidden"><span></span></div>
<section id="home" class="hidden">
<h2 data-i18n-key="welcomeTitle">Welcome to the Employee Review Portal</h2>
<p data-i18n-key="welcomeMsg">Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.</p>
</section>
<section id="reviews" class="hidden">
<form id="reviewForm" onsubmit="submitReview();return false;">
<div data-i18n-key="intro" data-i18n-html></div>
<div id="questionList"></div>
<div id="compAdjust" class="card hidden">
<label><span data-i18n-key="curWage">Current Wage</span><input type="number" id="curWage"></label>
<label><span data-i18n-key="newWage">New Wage</span><input type="number" id="newWage" oninput="calcPct()"></label>
<div><span data-i18n-key="pctIncrease">% Increase:</span> <span id="pctInc">0</span>%</div>
</div>
<div id="finalBlock" class="card">
<p data-i18n-key="finalExpTitle">Final Performance Expectation</p>
<label><input type="radio" name="finalExp" value="below"> <span data-i18n-key="belowExp">Below Expectations</span></label>
<label><input type="radio" name="finalExp" value="meets"> <span data-i18n-key="meetsExp">Meets Expectations</span></label>
<label><input type="radio" name="finalExp" value="exceeds"> <span data-i18n-key="exceedsExp">Exceeds Expectations</span></label>
<textarea id="finalNotes" data-i18n-key="notesPlaceholder" data-i18n-placeholder placeholder="Notes"></textarea>
<small data-i18n-key="contactQuestions">Contact Sea Khun with questions.</small>
</div>
<div class="card">
<label><span data-i18n-key="empSignature">Employee Signature</span><input type="text" id="empSign"></label>
<label><span data-i18n-key="mgrSignature">Manager Signature</span><input type="text" id="mgrSign"></label>
</div>
<button class="primary" type="submit" data-i18n-key="submitReview">Submit Review</button><span id="submitMsg"></span>
<button id="btnSchedule" class="primary mt-4" onclick="show('schedule')" data-i18n-key="scheduleBtn"></button>
</form>
</section>
<section id="schedule" class="hidden">
  <div id="scheduleForm" class="card shadow-lg p-4 flex flex-col gap-4">
    <label><span data-i18n-key="selDate">Date</span>
      <input type="date" id="selDate">
    </label>
    <label><span data-i18n-key="selTime">Time</span>
      <input type="time" id="selTime" step="1800">
    </label>
    <button class="primary" onclick="bookSimple()" data-i18n-key="book">Book</button>
    <div id="schedMsg" class="text-sm"></div>
  </div>
</section>
<section id="devPanel" class="hidden fixed inset-0 flex items-center justify-center">
  <div class="max-w-[420px] w-[90%] bg-white/80 backdrop-blur rounded-2xl shadow-xl p-8 flex flex-col gap-6">
    <h3 class="text-xl font-semibold text-gray-800 text-center">Admin Panel</h3>
    <label class="w-full">
      <span class="text-sm text-gray-500">UserID</span>
      <input type="text" id="newUserId" class="w-full h-11 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
    </label>
    <label class="w-full">
      <span class="text-sm text-gray-500">Role</span>
      <input type="text" id="newUserRole" class="w-full h-11 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
    </label>
    <label class="w-full">
      <span class="text-sm text-gray-500">Password</span>
      <input type="password" id="newUserPwd" class="w-full h-11 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
    </label>
    <button class="primary w-full h-12 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-semibold tracking-wide transition-transform active:scale-95" onclick="addNewUser()">Add User</button>
  </div>
</section>
<form id="login" class="hidden flex justify-center mt-8" onsubmit="login();return false;">
  <div class="max-w-[420px] w-[90%] bg-white/80 backdrop-blur rounded-2xl shadow-xl p-8 flex flex-col gap-6">
    <img src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png" alt="Logo" class="mx-auto" style="height:120px">
    <h1 class="text-2xl font-semibold text-gray-800 text-center" data-i18n-key="navTitle">Employee Annual Reviews</h1>
    <label class="w-full">
      <span class="text-sm text-gray-500" data-i18n-key="userId">User ID</span>
      <input class="w-full h-11 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" type="text" id="userId" data-i18n-key="userId" data-i18n-placeholder>
    </label>
    <label class="w-full">
      <span class="text-sm text-gray-500" data-i18n-key="password">Password</span>
      <input class="w-full h-11 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" type="password" id="password" data-i18n-key="password" data-i18n-placeholder>
    </label>
    <button class="primary w-full h-12 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-semibold tracking-wide transition-transform active:scale-95" type="submit" data-i18n-key="login">Login</button>
  </div>
</form>
</body>
</html>
