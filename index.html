<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Employee Reviews</title>
<style>
body{font-family:Roboto,Arial,sans-serif;margin:0;padding:0;background:#fafafa;color:#333;}
nav{display:flex;gap:10px;background:#6200ee;color:white;padding:10px;}
nav button{background:none;border:none;color:white;font-size:16px;cursor:pointer;padding:6px 12px;}
.lang-switch{display:flex;align-items:center;margin-left:auto;gap:4px;}
.switch{position:relative;display:inline-block;width:34px;height:18px;}
.switch input{opacity:0;width:0;height:0;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:34px;}
.slider:before{position:absolute;content:"";height:14px;width:14px;left:2px;bottom:2px;background:white;transition:.4s;border-radius:50%;}
.switch input:checked + .slider{background:#2196F3;}
.switch input:checked + .slider:before{transform:translateX(16px);}
section{padding:20px;}
.card{background:white;padding:15px;margin-bottom:10px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.2);} 
.hidden{display:none;}
label{display:block;margin-top:10px;}
input[type=text],textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:4px;}
select{padding:8px;}
 .rating-group label{display:inline-block;margin-right:10px;}
button.primary{background:#6200ee;color:white;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;}
/* Loading bar styles */
.loading-bar{height:4px;background:#eee;position:relative;overflow:hidden;}
.loading-bar span{display:block;height:100%;background:#6200ee;width:100%;animation:loadAnim 1.2s linear infinite;}
@keyframes loadAnim{from{transform:translateX(-100%);}to{transform:translateX(100%);}}
</style>
<script>
let user=null,config={},lang=localStorage.getItem('lang')||'en';
let loadingReviews=false;

const defaultQuestions=[
  {id:'attendance',en:'Attendance & Punctuality',es:'Asistencia y Puntualidad',extras:[
    {id:'absences',label:'Absences without notice (days)',label_es:'Ausencias sin aviso (días)',type:'number'},
    {id:'late',label:'Late arrivals (days)',label_es:'Llegadas tarde (días)',type:'number'},
    {id:'comments',label:'Comments',label_es:'Comentarios',type:'textarea'}]},
  {id:'performance',en:'Performance Improvements: What did you do more, better, or more efficiently last year, up till now?',es:'Mejoras de rendimiento',extra:'textarea'},
  {id:'values',en:'Living Our Core Values: How have you embodied our core values? Provide specific examples.',es:'Vivir nuestros valores',extra:'textarea'},
  {id:'growth',en:'Personal Growth: How did you improve your knowledge or skills last year, up till now?',es:'Crecimiento personal',extra:'textarea'},
  {id:'learning',en:'Learning New Skills: Did you take or create opportunities to learn a new skill or enhance an existing one?',es:'Aprendizaje de nuevas habilidades',extra:'textarea'},
  {id:'team',en:'Team Support: How did you support your teammates in developing their skills?',es:'Apoyo al equipo',extra:'textarea'},
  {id:'flexibility',en:'Flexibility: When asked to cover for others, did you agree? Share an example.',es:'Flexibilidad',extra:'textarea'},
  {id:'initiative',en:'Initiative: Describe a time you proactively improved a process or solved a problem without being asked.',es:'Iniciativa',extra:'textarea'},
  {id:'proactive',en:'Proactive Contributions: How did you proactively use downtime to tackle additional tasks?',es:'Contribuciones proactivas',extra:'textarea'},
  {id:'innovation',en:'Innovation & Process Improvement: Have you suggested or implemented improvements to our processes, services, or workplace? Describe your idea and its impact.',es:'Innovaci\u00f3n y mejora de procesos',extra:'textarea'},
  {id:'crossshadow',en:'Cross Shadowing Program Participation',es:'Programa Cross Shadowing',rating:false,extras:[
    {id:'participation',label:'Did you participate? (Yes/No/Partial)',label_es:'¿Participaste? (Sí/No/Parcial)',type:'select',options:['Yes','No','Partial']},
    {id:'comments',label:'Comments',label_es:'Comentarios',type:'textarea'}]},
  {id:'future',en:'Future Interests: Is there another role or skill you\u2019d like to explore in the future?',es:'Intereses futuros',rating:false,extra:'textarea'}
];
const translations={
  en:{
    home:'Home',reviews:'Reviews',schedule:'Schedule',
    welcomeTitle:'Welcome to the Employee Review Portal',
    welcomeMsg:'Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.',
    comingSoon:'Coming soon...',email:'Email',password:'Password',login:'Login',loginFail:'login fail',
    curWage:'Current Wage',newWage:'New Wage',pctIncrease:'% Increase:',
    finalExpTitle:'Final Performance Expectation',belowExp:'Below Expectations',meetsExp:'Meets Expectations',exceedsExp:'Exceeds Expectations',
    below:'Below',meets:'Meets',exceeds:'Exceeds',
    notesPlaceholder:'Notes',contactQuestions:'Contact Sea Khun with questions.',empSignature:'Employee Signature',mgrSignature:'Manager Signature',submitReview:'Submit Review',
    intro:`<b>Dublin Cleaners 2025 Employee Annual Reviews – Your Opportunity to Shine</b><br><b>Purpose</b> – Highlight achievements, live our core values, and explain why you deserve a pay increase while receiving growth feedback.<br><b>Core Values</b> Accountable · Attention to Details · Team Player · Tactical Risk Taker · Better than Yesterday · Value Reputation<br><b>Rating System</b> 1 = Below Expectations · 2 = Meets Expectations · 3 = Exceeds Expectations (Attendance &amp; punctuality, Q1, is weighted higher)<br><b>Review Process</b> July reviews → submit form → Manager/Assistant adds notes → schedule 20-min meeting (half-hour slots) ≥ 1 week after submission. Schedule outside regular hours; compensated if on day off/outside shift.<br>Please Message HR about how long your meeting was so they can Add your hours into UKG<br><b>Raises take effect on the first pay period in August.</b>`
  },
  es:{
    home:'Inicio',reviews:'Reseñas',schedule:'Agenda',
    welcomeTitle:'Bienvenido al Portal de Evaluaciones',
    welcomeMsg:'Seleccione una opción en la barra de navegación para ver sus evaluaciones o programar una reunión. Use el botón de idioma para cambiar entre inglés y español.',
    comingSoon:'Próximamente...',email:'Correo electrónico',password:'Contraseña',login:'Iniciar sesión',loginFail:'Error al iniciar sesión',
    curWage:'Salario actual',newWage:'Nuevo salario',pctIncrease:'% Aumento:',
    finalExpTitle:'Expectativa de desempeño final',belowExp:'Debajo de las expectativas',meetsExp:'Cumple con las expectativas',exceedsExp:'Supera las expectativas',
    below:'Debajo',meets:'Cumple',exceeds:'Supera',
    notesPlaceholder:'Notas',contactQuestions:'Contacte a Sea Khun con preguntas.',empSignature:'Firma del empleado',mgrSignature:'Firma del gerente',submitReview:'Enviar revisión',
    intro:`<b>Dublin Cleaners Evaluaciones Anuales de Empleados 2025 – Tu oportunidad para destacar</b><br><b>Propósito</b> – Destacar logros, vivir nuestros valores fundamentales y explicar por qué mereces un aumento mientras recibes comentarios para crecer.<br><b>Valores fundamentales</b> Responsabilidad · Atención al detalle · Trabajo en equipo · Tomador de riesgos táctico · Mejor que ayer · Valorar la reputación<br><b>Sistema de calificación</b> 1 = Por debajo de las expectativas · 2 = Cumple con las expectativas · 3 = Supera las expectativas (Asistencia y puntualidad, P1, tiene mayor peso)<br><b>Proceso de revisión</b> Revisiones de julio → enviar formulario → el gerente/asistente agrega notas → programar una reunión de 20 minutos (bloques de media hora) ≥ 1 semana después de la entrega. Programar fuera del horario habitual; se compensa si es día libre/fuera del turno.<br>Informe a RRHH cuánto duró la reunión para que puedan agregar sus horas a UKG<br><b>Los aumentos entran en vigor en el primer periodo de pago de agosto.</b>`
  }
};
function t(key){
  if(config[key]&&config[key][lang])return config[key][lang];
  if(translations[lang]&&translations[lang][key])return translations[lang][key];
  return key;
}
function startLoading(){
  document.body.style.background='#fff';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.remove('hidden');
  loadingReviews=true;
}
function stopLoading(){
  document.body.style.background='';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.add('hidden');
  loadingReviews=false;
}
function show(id){
  document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
  if(id==='reviews'){
    startLoading();
    loadQuestions();
  }else{
    document.getElementById(id).classList.remove('hidden');
  }
}
function applyTranslations(){
  document.querySelectorAll('[data-i18n-key]').forEach(el=>{
    const key=el.dataset.i18nKey;
    if(el.hasAttribute('data-i18n-placeholder'))el.placeholder=t(key);
    else if(el.hasAttribute('data-i18n-html'))el.innerHTML=t(key);
    else if(el.hasAttribute('data-i18n-alt'))el.alt=t(key);
    else el.textContent=t(key);
  });
  const toggle=document.getElementById('langToggle');
  if(toggle)toggle.checked=lang==='es';
}
function init(){
  show('home');
  applyTranslations();
  loadQuestions();
  google.script.run.withSuccessHandler(c=>{config=c;loadSession();}).loadConfig();
}
function loadSession(){
  google.script.run.withSuccessHandler(u=>{
    if(u){
      user=u;
      lang=u.lang;
      localStorage.setItem('lang',lang);
      applyTranslations();
      loadReviews();
      show('home');
    }else{
      document.getElementById('login').classList.remove('hidden');
      applyTranslations();
    }
  }).getSession();
}
function login(){
  const e=document.getElementById('email').value;
  const p=document.getElementById('pw').value;
  google.script.run.withSuccessHandler(r=>{
    if(r.success){
      user=r.user;
      lang=user.lang;
      localStorage.setItem('lang',lang);
      document.getElementById('login').classList.add('hidden');
      applyTranslations();
      loadReviews();
      show('home');
    }else{
      alert(t('loginFail'));
    }
  }).login(e,p);
}
function toggleLang(){
  lang=document.getElementById('langToggle').checked?'es':'en';
  if(google&&google.script&&google.script.run)google.script.run.saveLang(lang);
  localStorage.setItem('lang',lang);
  applyTranslations();
  renderReviews();
  renderQuestionList();
}
let reviews=[];
function loadReviews(){google.script.run.withSuccessHandler(r=>{reviews=r;renderReviews();}).listReviews();}
function renderReviews(){const c=document.getElementById('reviewsList');if(!c)return;c.innerHTML='';reviews.forEach(rv=>{const div=document.createElement('div');div.className='card';div.innerHTML='<b>'+rv.type+'</b> '+rv.status+'<br>'+JSON.stringify(rv.data);c.appendChild(div);});}

let questions=[];
function loadQuestions(){
  if(typeof google==='undefined'||!google.script||!google.script.run){
    questions=defaultQuestions;
    renderQuestionList();
    return;
  }
  google.script.run
    .withSuccessHandler(q=>{
      questions=(q&&q.length)?q:defaultQuestions;
      renderQuestionList();
    })
    .withFailureHandler(err=>{
      console.error('loadQuestions failed',err);
      questions=defaultQuestions;
      renderQuestionList();
    })
    .getQuestions();
}
function renderQuestionList(){
  const qd=document.getElementById('questionList');
  if(!qd)return;
  qd.innerHTML='';
  questions.forEach(q=>{
    const div=document.createElement('div');
    div.className='card q';
    div.dataset.id=q.id;
    let html='<label class="question-title">'+q[lang]+'</label>';
    if(q.rating!==false){
      html+='<div class="rating-group">'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="1"> 1 - '+t('below')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="2"> 2 - '+t('meets')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="3"> 3 - '+t('exceeds')+'</label>'
        +'</div>';
    }else{
      html+='<input type="hidden" class="rating" value="">';
    }
    if(Array.isArray(q.extras)){
      q.extras.forEach(ex=>{
        const lbl=ex['label_'+lang]||ex.label;
        html+='<label>'+lbl;
        if(ex.type==='textarea')html+='<textarea class="extra" data-sub="'+ex.id+'"></textarea>';
        else if(ex.type==='select'){
          html+='<select class="extra" data-sub="'+ex.id+'">';
          ex.options.forEach(o=>{html+='<option value="'+o+'">'+o+'</option>';});
          html+='</select>';
        }else html+='<input type="'+ex.type+'" class="extra" data-sub="'+ex.id+'">';
        html+='</label>';
      });
    }else if(q.extra==='textarea'){
      html+='<textarea class="extra"></textarea>';
    }else if(q.extra==='number'){
      html+='<input type="number" class="extra">';
    }
    div.innerHTML=html;
    qd.appendChild(div);
  });
  if(user&&user.role&&(['MANAGER','HR','DEV'].indexOf(user.role)!==-1)){
    document.getElementById('compAdjust').classList.remove('hidden');
  }
  if(loadingReviews){
    document.getElementById('reviews').classList.remove('hidden');
    stopLoading();
  }
}
function calcPct(){const c=parseFloat(document.getElementById('curWage').value||0);const n=parseFloat(document.getElementById('newWage').value||0);const pct=document.getElementById('pctInc');pct.textContent=c?(((n-c)/c)*100).toFixed(2):'0';}
function submitReview(){
  const ans={};
  document.querySelectorAll('#questionList .q').forEach(d=>{
    const id=d.dataset.id;
    const ratingEl=d.querySelector('input.rating:checked, select.rating');
    const rating=ratingEl?ratingEl.value:'';
    const extraEls=d.querySelectorAll('.extra');
    let extra='';
    if(extraEls.length===1 && !extraEls[0].dataset.sub){
      extra=extraEls[0].value||'';
    }else if(extraEls.length>0){
      extra={};
      extraEls.forEach(e=>{extra[e.dataset.sub||'value']=e.value;});
    }
    ans[id]={score:rating,extra:extra};
  });
  const review={employeeId:user.id,type:'SELF',data:{answers:ans}};
  google.script.run.withSuccessHandler(r=>{
    const adjBlock=document.getElementById('compAdjust');
    if(!adjBlock.classList.contains('hidden')){
      const adj={employeeId:user.id,current:document.getElementById('curWage').value,new:document.getElementById('newWage').value,pct:document.getElementById('pctInc').textContent};
      google.script.run.saveCompAdjustment(r.id,adj);
    }
    const exp={result:document.querySelector('input[name=finalExp]:checked')?.value||'',notes:document.getElementById('finalNotes').value,empSign:{name:document.getElementById('empSign').value,ts:new Date().toISOString()},mgrSign:{name:document.getElementById('mgrSign').value,ts:new Date().toISOString()}};
    google.script.run.saveFinalExpectation(r.id,exp);
    loadReviews();
    alert('Saved');
  }).saveReview(review);
}
document.addEventListener('DOMContentLoaded',init);
</script>
</head>
<body>
<nav>
<button onclick="show('home')" data-i18n-key="home">Home</button>
<button onclick="show('reviews')" data-i18n-key="reviews">Reviews</button>
<button onclick="show('schedule')" data-i18n-key="schedule">Schedule</button>
<div class="lang-switch">
  <span>EN</span>
  <label class="switch"><input type="checkbox" id="langToggle" onchange="toggleLang()"><span class="slider"></span></label>
  <span>ES</span>
</div>
</nav>
<div id="loadingBar" class="loading-bar hidden"><span></span></div>
<section id="home" class="hidden">
<h2 data-i18n-key="welcomeTitle">Welcome to the Employee Review Portal</h2>
<p data-i18n-key="welcomeMsg">Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.</p>
<div id="reviewsList"></div>
</section>
<section id="reviews" class="hidden">
<div class="card" style="max-height:160px;overflow:auto;" data-i18n-key="intro" data-i18n-html></div>
<div id="questionList"></div>
<div id="compAdjust" class="card hidden">
<label><span data-i18n-key="curWage">Current Wage</span><input type="number" id="curWage"></label>
<label><span data-i18n-key="newWage">New Wage</span><input type="number" id="newWage" oninput="calcPct()"></label>
<div><span data-i18n-key="pctIncrease">% Increase:</span> <span id="pctInc">0</span>%</div>
</div>
<div id="finalBlock" class="card">
<p data-i18n-key="finalExpTitle">Final Performance Expectation</p>
<label><input type="radio" name="finalExp" value="below"> <span data-i18n-key="belowExp">Below Expectations</span></label>
<label><input type="radio" name="finalExp" value="meets"> <span data-i18n-key="meetsExp">Meets Expectations</span></label>
<label><input type="radio" name="finalExp" value="exceeds"> <span data-i18n-key="exceedsExp">Exceeds Expectations</span></label>
<textarea id="finalNotes" data-i18n-key="notesPlaceholder" data-i18n-placeholder placeholder="Notes"></textarea>
<small data-i18n-key="contactQuestions">Contact Sea Khun with questions.</small>
</div>
<div class="card">
<label><span data-i18n-key="empSignature">Employee Signature</span><input type="text" id="empSign"></label>
<label><span data-i18n-key="mgrSignature">Manager Signature</span><input type="text" id="mgrSign"></label>
</div>
<button class="primary" onclick="submitReview()" data-i18n-key="submitReview">Submit Review</button>
</section>
<section id="schedule" class="hidden">
<p data-i18n-key="comingSoon">Coming soon...</p>
</section>
<div id="login" class="hidden">
<label><span data-i18n-key="email">Email</span><input type="text" id="email" data-i18n-key="email" data-i18n-placeholder></label>
<label><span data-i18n-key="password">Password</span><input type="password" id="pw" data-i18n-key="password" data-i18n-placeholder></label>
<button class="primary" onclick="login()" data-i18n-key="login">Login</button>
</div>
</body>
</html>
